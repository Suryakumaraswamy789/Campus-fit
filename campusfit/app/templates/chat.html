<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with {{ other_user.full_name }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f7f9; margin: 0; }
        .chat-container { max-width: 800px; margin: 20px auto; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,.08); border-radius: 10px; display: flex; flex-direction: column; height: 90vh; }
        .chat-header { background: #2c3e50; color: #fff; padding: 15px; border-radius: 10px 10px 0 0; }
        .chat-header h2 { margin: 0; font-size: 1.2em; }
        .chat-log { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message { margin-bottom: 15px; }
        .message .meta { font-size: 0.8em; color: #777; margin-bottom: 5px; }
        .message .meta strong { color: #333; }
        .message .content { padding: 10px 15px; border-radius: 15px; max-width: 70%; display: inline-block; }
        .message.sent { text-align: right; }
        .message.sent .content { background: #00c6ff; color: #fff; }
        .message.received .content { background: #e9ecef; }
        .chat-form { display: flex; padding: 15px; border-top: 1px solid #eee; }
        #chat-message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        #chat-message-submit { padding: 10px 20px; margin-left: 10px; border: none; background: #2c3e50; color: #fff; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>Chat with {{ other_user.full_name }}</h2>
            <small>Regarding Booking on {{ booking.session_date|date:"d M Y" }}</small>
        </div>
        <div class="chat-log" id="chat-log">
            {% for msg in messages %}
                <div class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
                    <div class="meta"><strong>{{ msg.sender.full_name }}</strong> at {{ msg.timestamp|date:"h:i A" }}</div>
                    <div class="content">{{ msg.content }}</div>
                </div>
            {% endfor %}
        </div>
        <div class="chat-form">
            <input id="chat-message-input" type="text" placeholder="Type your message...">
            <button id="chat-message-submit">Send</button>
        </div>
    </div>

    {{ booking.id|json_script:"booking-id" }}
    {{ other_user.id|json_script:"receiver-id" }}
    {{ request.user.full_name|json_script:"sender-name" }}

    <script>
        const bookingId = JSON.parse(document.getElementById('booking-id').textContent);
        const receiverId = JSON.parse(document.getElementById('receiver-id').textContent);
        const senderName = JSON.parse(document.getElementById('sender-name').textContent);
        const chatLog = document.getElementById('chat-log');

        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + bookingId + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            const metaDiv = document.createElement('div');
            metaDiv.classList.add('meta');
            metaDiv.innerHTML = `<strong>${data.sender_name}</strong> at ${data.timestamp}`;

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('content');
            contentDiv.textContent = data.message;

            if (data.sender_name === senderName) {
                messageDiv.classList.add('sent');
            } else {
                messageDiv.classList.add('received');
            }

            messageDiv.appendChild(metaDiv);
            messageDiv.appendChild(contentDiv);
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') { document.querySelector('#chat-message-submit').click(); }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            if (message.trim() === '') return;
            chatSocket.send(JSON.stringify({
                'message': message,
                'receiver_id': receiverId
            }));
            messageInputDom.value = '';
        };
        chatLog.scrollTop = chatLog.scrollHeight;
    </script>
</body>
</html>